---
import { resolve } from 'path';
import ArticleLayout from '../components/article/ArticleLayout.astro';
import MainHead from '../components/meta/MainHead.astro';
import Social from '../components/meta/Social.astro';
import { dateFromString } from '../scripts/date';
import { postAccentColor } from '../scripts/posts';
import '../styles/font-extra.css';

const { content } = Astro.props;

const POST_PATH = /^\/(posts|talks)\/([-\w]+)/;
function postBanner(bannerFile: string | undefined) {
  const match = POST_PATH.exec(Astro.canonicalURL.pathname);
  if (match && bannerFile) {
    const [, folder, slug] = match;
    return resolve(process.cwd(), `src/pages/${folder}/${slug}/${bannerFile}`);
  }
  return undefined;
}

const formattedProps = {
  title: content.title,
  href: Astro.canonicalURL,
  accent: postAccentColor(content.tags),
  date: content.date ? dateFromString(content.date) : undefined,
  lastMod: content.lastMod ? dateFromString(content.lastMod) : undefined,
  description: content.description,
  tags: content.tags,
  elsewhere: content.elsewhere,
  tableOfContents: content.toc ? content.astro.headers : undefined,
};
---

<html lang="en">
  <head>
    <MainHead
      title={content.title}
      description={content.description}
      canonical={content.elsewhere?.link ?? Astro.canonicalURL}
    />
    <Social
      title={content.title}
      description={content.description}
      pictureSrc={postBanner(content.banner)}
      pictureAlt={content.banner_alt}
    />
  </head>

  <body class="bg-slate-800 text-slate-200">
    <ArticleLayout {...formattedProps}>
      <slot />
    </ArticleLayout>
  </body>
</html>
